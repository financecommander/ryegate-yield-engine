name: Security Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Mondays at 9am UTC
    - cron: '0 9 * * 1'

jobs:
  slither:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install --legacy-peer-deps
      - uses: crytic/slither-action@v0.4.0
        continue-on-error: true
        with:
          fail-on: high
          slither-args: --filter-paths "node_modules|contracts/mocks"
  
  solhint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install --legacy-peer-deps
    
    - name: Run Solhint
      continue-on-error: true
      run: npx solhint 'contracts/**/*.sol' --config .solhint.json
    
    - name: Check Solhint results
      run: |
        npx solhint 'contracts/**/*.sol' --config .solhint.json > solhint-report.txt 2>&1 || true
        if grep -q "error" solhint-report.txt; then
          echo "❌ Solhint errors found"
          cat solhint-report.txt
          exit 1
        else
          echo "✅ No Solhint errors"
        fi
  
  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Run npm audit
      run: |
        npm audit --audit-level=high || true
    
    - name: Check for critical vulnerabilities
      run: |
        CRITICAL=$(npm audit --json | jq '.metadata.vulnerabilities.critical // 0')
        HIGH=$(npm audit --json | jq '.metadata.vulnerabilities.high // 0')
        
        echo "Critical vulnerabilities: $CRITICAL"
        echo "High vulnerabilities: $HIGH"
        
        if [ "$CRITICAL" -gt 0 ]; then
          echo "❌ Critical vulnerabilities found in dependencies"
          npm audit
          exit 1
        elif [ "$HIGH" -gt 5 ]; then
          echo "⚠️ Warning: $HIGH high severity vulnerabilities found"
        else
          echo "✅ No critical vulnerabilities"
        fi
  
  mythril:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Mythril analysis scheduled for pre-mainnet audit"
